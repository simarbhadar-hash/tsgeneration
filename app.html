<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Entry Manager тАФ Devanagari + Letterhead</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
body{
  font-family:"Noto Sans Devanagari", system-ui, sans-serif;
  background:#f7fafc;
  margin:16px;
}
.wrap{
  max-width:1100px;
  margin:auto;
  background:#fff;
  padding:18px;
  border-radius:8px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}
textarea{
  width:100%;
  min-height:140px;
  padding:10px;
  box-sizing:border-box;
}
.detect-row,.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.field-input{
  min-width:140px;
  padding:8px;
}
.preview{
  border:1px dashed #cbd5e1;
  padding:12px;
  margin-top:10px;
  white-space:pre-wrap;
  font-family:"Noto Sans Devanagari", Mangal;
}
.preview div{margin:0;padding:0}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:16px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
}
th{background:#f1f5f9}

button{
  padding:8px 12px;
  border:0;
  border-radius:6px;
  cursor:pointer;
}
.alt{background:#94a3b8}
.small-btn{background:#0ea5a3;color:#fff}
.excel-btn{background:#16a34a;color:#fff}

.letterhead-preview{
  width:100%;
  max-height:110px;
  object-fit:contain;
  margin-top:8px;
}
#templateArea.hidden{
  display:none;
}
</style>
</head>

<body>
<div class="wrap">

<h2>Technical Sanction Generation ЁЯУД</h2>
<button id="toggleTemplate" class="alt" style="margin-bottom:6px;">
  Show / Edit Template ЁЯУЭ
</button>
<textarea id="templateArea"><div style="
font-weight:700;
font-size:16pt;
text-align:center;
font-family:'Noto Sans Devanagari', Mangal;
margin:0;
padding:0;
">---рддрдХрдиреАрдХреА рд╕реНрд╡реАрдХреГрддреА---</div>
рддрдХрдиреАрдХреА рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░. рд╕рдВ.- {{TS_No}}                                                                               рджрд┐рдирд╛рдВрдХ - {{TS_Date}}

рдпреЛрдЬрдирд╛ рдХрд╛ рдирд╛рдо 	{{Project}} рдХреЗ рдЕрдВрддрд░реНрдЧрдд рдирд┐рдореНрди рдХрд╛рд░реНрдп рдХреА рддрдХрдиреАрдХреА рд╕реНрд╡реАрдХреГрддрд┐ рдПрддрдж рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИ ред 
1.	рдХрд╛рд░реНрдп рдХрд╛ рдирд╛рдо - {{Work_name}}
2.	рдЧреНрд░рд╛рдо рд╡ рдХрд╛рд░реНрдп рд╕реНрдерд▓ тАУ {{Village}}  рдЧреНрд░рд╛рдо рдкрдВрдЪрд╛рдпрдд  тАУ  {{Gram_Panchayat}}   рдкрдВ. рд╕. тАУ {{Panchayat_Samiti}}
3.	рд╡рд╛рд░реНрд╖рд┐рдХ рдХрд╛рд░реНрдп рдпреЛрдЬрдирд╛ рдХреНрд░рдо рд╕рдВрдЦреНрдпрд╛ : {{AAP_No}}
4.	рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░рдорд╛рдВрдХ. {{FS_No}}    			                        рджрд┐рдирд╛рдВрдХ : {{FS_Date}}	
5.	рдХрд╛рд░реНрдп рдкреВрд░реНрдг рд╣реЛрдиреЗ рдХреА рдЕрдиреБрдорд╛рдирд┐рдд рдЕрд╡рдзрд┐  - {{Work_Period_Months}} рдорд╛рд╣ 
6.	рд╕реНрд╡реАрдХреГрдд рд░рд╛рд╢рд┐ рдкрд░рд┐рд╢рд┐рд╖реНрда тАУ 6 рдореЗрдВ рдЕрдВрдХрд┐рдд рд▓рд╛рдЧрдд рдЕрдиреБрдорд╛рди рдХреЗ рдЕрдиреБрд╕рд╛рд░ :
рдЕ. 	рд╢реНрд░рдо рдШрдЯрдХ : рдирдХрдж рд░рд╛рд╢рд┐  {{Labour_Amt}}
рдм. 	рд╕рд╛рдордЧреНрд░реА  рдШрдЯрдХ {{Material_Amt}}             
	рдХреБрд▓ рд░рд╛рд╢рд┐ (рдЕ+рдм) : {{Total_Amt}}/-     
	рдпрд╣ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рдХрд╛рд░реНрдп рдХрд╛ рдЕрдиреБрдорд╛рди рдЧреНрд░рд╛рдореАрдг рд╡рд┐рдХрд╛рд╕ рдПрд╡рдВ рдкрдВрдЪрд╛рдпрддреАрд░рд╛рдЬ рд╡рд┐рднрд╛рдЧ (рдЖрдпреБрдХреНрддрд╛рд▓рдп рдЬрд▓рдЧреНрд░рд╣рдг рд╡рд┐рдХрд╛рд╕ рдПрд╡рдВ рднреВ-рд╕рдВрд░рдХреНрд╖рдг рд╡рд┐рднрд╛рдЧ рд░рд╛рдЬрд╕реНрдерд╛рди. рдЬрдпрдкреБрд░ рдХреЗ рдЖрджреЗрд╢ рдХреНрд░рдорд╛рдВрдХ рдПрдл. 20(229) рдЖрдЬрднреВрд╕/рдкреАрдПрдлрд╕реА/2018/5293-408 рджрд┐. 12.02.2018 рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрддреНрдд рд╢рдХреНрддрд┐рдпрд╛ рдкреНрд░рд╛рд╡рдзрд╛рди рдЕрдиреБрд╕рд╛рд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдорд╛рдирдЪрд┐рддреНрд░ рдореЗрдВ рджрд┐рдпреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдпреЗ рдпрд░реНрдерд╛рдд рдореЗрдВ рдЧрдгрдирд╛ рдХрд░ рдорд╛рддреНрд░рд╛ рдирд┐рдХрд╛рд▓реА рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд╡рд┐рд╡рд░рдг рддрдерд╛ рджрд░реЛрдВ рдХреА рд╕рддреНрдпрддрд╛ рд╕реЗ рдЬрд╛рдВрдЪ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ ред рдкреНрд░рд╕реНрддрд╛рд╡ рдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд┐рджреНрдзрд╛рдВрдд, рдмрдирд╛рд╡рдЯ рдХреА рдареЛрд╕рддрд╛ рдПрдВрд╡ рдХрд╛рд░реНрдп рдХреА рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХреЛ рдХрд╛рд░реНрдп рд╕реНрдерд▓ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░, рдирд┐рд░реНрдорд╛рдг рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ ред 

                                                                                                                           ({{Officer}})
                                                                                                                      рдЕрдзрд┐рд╢рд╛рд╖реА рдЕрднрд┐рдпрдиреНрддрд╛
                                                                                                              рдЬрд▓рдЧреНрд░рд╣рдг рд╡рд┐рдХрд╛рд╕ рдПрд╡рдВ рднреВ-рд╕рдВрд░рдХреНрд╖рдг
                                                                                                                рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ рд╣рдиреБрдорд╛рдирдЧреЭ 
рддрдХрдиреАрдХреА рд╕реНрд╡реАрдХреГрддрд┐ рдХреНрд░. рд╕рдВ.- {{TS_No}}                                                                               рджрд┐рдирд╛рдВрдХ - {{TS_Date}}
рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ : 
1.	рдЕрдзреАрдХреНрд╖рдг рдЕрднрд┐рдпрдВрддрд╛ рдПрдВрд╡ рдкрд░рд┐рдпреЛрдЬрдирд╛  рдкреНрд░рдмрдВрдзрдХ рдбрдмрд▓реНрдпреВ рд╕реА рдбреА рд╕реА  рдЬрд┐рд▓рд╛ рдкрд░рд┐рд╖рдж рд╣рдиреБрдорд╛рдирдЧреЭ ред 

                                                                                                                      рдЕрдзрд┐рд╢рд╛рд╖реА рдЕрднрд┐рдпрдиреНрддрд╛
                                                                                                              рдЬрд▓рдЧреНрд░рд╣рдг рд╡рд┐рдХрд╛рд╕ рдПрд╡рдВ рднреВ-рд╕рдВрд░рдХреНрд╖рдг
                                                                                                                рдкрдВрдЪрд╛рдпрдд рд╕рдорд┐рддрд┐ рд╣рдиреБрдорд╛рдирдЧреЭ </textarea>

<!-- Letterhead -->
<div class="detect-row">
  <label>Upload HeaderЁЯУд:</label>
  <input type="file" id="letterheadFile" accept="image/*">
  <button id="clearLetterhead" class="alt">Clear</button>
</div>
<img id="letterPreview" class="letterhead-preview" style="display:none">

<div class="detect-row">
  <button id="detectBtn">Detect Fields ЁЯФН</button>
  <div id="fieldsContainer"></div>
</div>

<div class="controls">
  <button id="saveBtn">Save Entry ЁЯТ╛ЁЯФД</button>
  <button id="previewBtn" class="alt">Preview ЁЯСБя╕ПтАНЁЯЧия╕П</button>
  <button id="pdfBtn" class="alt">Download PDF тмЗя╕П</button>
  <button id="printBtn" class="alt">Print ЁЯЦия╕П</button>
  <button id="excelBtn" class="excel-btn">Export Excel ЁЯУд</button>
<button id="backupBtn" class="alt">Backup Data ЁЯЧДя╕П</button>
<button id="restoreBtn" class="alt">Restore Data тЩ╗я╕П</button>
<input type="file" id="restoreFile" accept=".json" style="display:none">
</div>

<div id="preview" class="preview"></div>

<table>
<thead id="tableHead"></thead>
<tbody id="savedTable"></tbody>
</table>

</div>

<script>
const templateArea=document.getElementById('templateArea');
/* ===== GOOGLE SHEET API ===== */
const SHEET_API_URL =
"https://script.google.com/macros/s/AKfycbxSlyrsViyD5R1e30mWMnftQPDFT6P207xxea5Z1558QG9mwkOy0pzHmEcn8PEhO2qQuA/exec";
/* RESTORE TEMPLATE FROM STORAGE */
const savedTemplate = localStorage.getItem('SAVED_TEMPLATE');
if(savedTemplate){
  templateArea.value = savedTemplate;
}
const TEMPLATE_PASSWORD = "Aman";
const fieldsContainer=document.getElementById('fieldsContainer');
const toggleBtn = document.getElementById('toggleTemplate');
/* page load pe template PURA hide */
templateArea.classList.add('hidden');
toggleBtn.onclick = ()=>{
  if(templateArea.classList.contains('hidden')){
    const pass = prompt("Enter Secret Code ЁЯФТ");
    if(pass !== TEMPLATE_PASSWORD){
      alert("Incorrect Code тЭМ");
      return;
    }
    templateArea.classList.remove('hidden');
    toggleBtn.textContent = 'Hide Template';
  }else{
    templateArea.classList.add('hidden');
    toggleBtn.textContent = 'Show Template';
  }
};

const previewEl=document.getElementById('preview');
const savedTable=document.getElementById('savedTable');
const tableHead=document.getElementById('tableHead');
const excelBtn=document.getElementById('excelBtn');
const letterInput=document.getElementById('letterheadFile');
const letterPreview=document.getElementById('letterPreview');
const clearLetter=document.getElementById('clearLetterhead');

let LETTERHEAD_BASE64=localStorage.getItem('LETTERHEAD_BASE64');
let detectedFields=[];
let entries=JSON.parse(localStorage.getItem('entries_v1')||'[]');
/* =========================================================
   LETTERHEAD UPLOAD (NETLIFY + PRINT/PDF SAFE)
   ========================================================= */

/* restore header on page load */
if(LETTERHEAD_BASE64){
  letterPreview.src = LETTERHEAD_BASE64;
  letterPreview.style.display = 'block';
}

/* upload new header */
letterInput.onchange = e => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = () => {
    LETTERHEAD_BASE64 = reader.result;   // Base64 image

    // show preview
    letterPreview.src = LETTERHEAD_BASE64;
    letterPreview.style.display = 'block';

    // ЁЯФе IMPORTANT: save for Netlify print/pdf
    localStorage.setItem('LETTERHEAD_BASE64', LETTERHEAD_BASE64);
  };

  reader.readAsDataURL(file);  // MUST
};

/* clear header */
clearLetter.onclick = ()=>{
  LETTERHEAD_BASE64 = null;
  localStorage.removeItem('LETTERHEAD_BASE64');
  letterPreview.style.display = 'none';
};

/* FIELD DETECT */
function detectFieldsFromTemplate(tpl){
  const re=/{{\s*([a-zA-Z0-9_]+)\s*}}/g;
  let m,arr=[];
  while((m=re.exec(tpl))!==null) arr.push(m[1]);
  return [...new Set(arr)];
}

function renderFields(){
  fieldsContainer.innerHTML='';
  detectedFields.forEach(f=>{
    const i=document.createElement('input');
    i.className='field-input';
    i.placeholder=f;
    i.dataset.f=f;
    i.oninput=updatePreview;
    fieldsContainer.appendChild(i);
  });
  updatePreview();
}

function fillTemplate(obj){
  let out=templateArea.value;
  detectedFields.forEach(f=>{
    const v=obj?obj[f]:(document.querySelector(`[data-f="${f}"]`)?.value||'');
    const boldVal = `<span style="font-weight:700">${v}</span>`;
    out=out.replaceAll(`{{${f}}}`,boldVal)
           .replaceAll(`{{ ${f} }}`,boldVal);
  });
  return out;
}

/* PREVIEW */
function updatePreview(){
  previewEl.innerHTML = fillTemplate();
}

/* INIT */
const savedFields = JSON.parse(localStorage.getItem('SAVED_FIELDS')||'null');

if(savedFields && savedFields.length){
  detectedFields = savedFields;
}else{
  detectedFields = detectFieldsFromTemplate(templateArea.value);
}

renderFields();
renderSaved();


/* EVENTS */
detectBtn.onclick=()=>{
  detectedFields = detectFieldsFromTemplate(templateArea.value);

  /* SAVE template + fields */
  localStorage.setItem('SAVED_TEMPLATE', templateArea.value);
  localStorage.setItem('SAVED_FIELDS', JSON.stringify(detectedFields));

  renderFields();
  renderSaved();
};

/* ===== SAVE ENTRY TO GOOGLE SHEET ===== */
/* ===== SAVE ENTRY : GOOGLE SHEET + LOCAL TABLE ===== */
saveBtn.onclick = async ()=>{
  const data = {};

  // 1я╕ПтГг collect form data
  detectedFields.forEach(f=>{
    data[f] =
      document.querySelector(`[data-f="${f}"]`)?.value || '';
  });

  /* 2я╕ПтГг SAVE TO GOOGLE SHEET (background) */
  try{
    fetch(SHEET_API_URL,{
      method:'POST',
      mode:'no-cors',
      body: JSON.stringify(data)
    });
  }catch(err){
    console.warn('Sheet save failed', err);
  }

  /* 3я╕ПтГг SAVE TO LOCAL TABLE (instant UI) */
  entries.push(data);
  localStorage.setItem('entries_v1', JSON.stringify(entries));
  renderSaved();

  /* 4я╕ПтГг OPTIONAL : clear inputs */
  detectedFields.forEach(f=>{
    const el = document.querySelector(`[data-f="${f}"]`);
    if(el) el.value = '';
  });

  updatePreview();

  alert("тЬЕ Entry saved (Sheet + Table)");
};

previewBtn.onclick=updatePreview;

/* TABLE */
function renderSaved(){
  tableHead.innerHTML='';
  savedTable.innerHTML='';
  if(!detectedFields.length) return;

  let th='<tr>';
  detectedFields.forEach(f=>th+=`<th>${f}</th>`);
  th+='<th>Print ЁЯЦия╕П</th><th>Delete тЭМ</th></tr>';
  tableHead.innerHTML=th;

  entries.forEach((e,i)=>{
    let tr='<tr>';
    detectedFields.forEach(f=>tr+=`<td>${e[f]||''}</td>`);
    tr+=`
      <td>
        <button class="small-btn" onclick="printEntry(${i})">Print</button>
      </td>
      <td>
        <button class="small-btn" onclick="deleteEntry(${i})">Delete</button>
      </td>
    </tr>`;
    savedTable.innerHTML+=tr;
  });
}

function deleteEntry(i){
  if(confirm('Delete this entry?')){
    entries.splice(i,1);
    localStorage.setItem('entries_v1',JSON.stringify(entries));
    renderSaved();
  }
}

/* тЬЕ PDF тАФ NO GAP */
pdfBtn.onclick=()=>{
  const page=document.createElement('div');
  page.style.width='170mm';
  page.style.whiteSpace='pre-wrap';
  page.innerHTML =
    (LETTERHEAD_BASE64
      ? `<img src="${LETTERHEAD_BASE64}" style="width:100%;display:block">`
      : ''
    ) + fillTemplate().replace(/^\s+/,'');

  html2pdf().set({
    margin:[20,20,20,20],
    filename:'entry.pdf',
    html2canvas:{scale:1.5},
    jsPDF:{unit:'mm',format:'a4'}
  }).from(page).save();
};

/* PRINT тАФ NO GAP */
printBtn.onclick=()=>{
  const w=window.open('');
  w.document.write(`
  <html><body style="margin:0;white-space:pre-wrap;font-family:'Noto Sans Devanagari'">
  ${LETTERHEAD_BASE64?`<img src="${LETTERHEAD_BASE64}" style="width:100%;display:block">`:''}
  ${fillTemplate().replace(/^\s+/, '')}
  </body></html>`);
  w.document.close();
  w.onload=()=>w.print();
};
function printEntry(i){
   const w = window.open('');
  w.document.write(`
    <html><body style="margin:0;white-space:pre-wrap;font-family:'Noto Sans Devanagari'">
    ${LETTERHEAD_BASE64?`<img src="${LETTERHEAD_BASE64}" style="width:100%;display:block">`:''}
    ${fillTemplate(entries[i]).replace(/^\s+/, '')}
    </body></html>
  `);
  w.document.close();
  w.onload = () => w.print();
}
/* тЬЕ EXPORT EXCEL (CSV) */
excelBtn.onclick=()=>{
  if(!entries.length){ alert('No data'); return; }
  let csv=detectedFields.join(',')+'\n';
  entries.forEach(e=>{
    csv+=detectedFields.map(f=>`"${(e[f]||'').replace(/"/g,'""')}"`).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='entries.csv';
  a.click();
};
/* ================= BACKUP ================= */
backupBtn.onclick = ()=>{
  const backupData = {
    template: templateArea.value,
    fields: detectedFields,
    entries: entries,
    letterhead: LETTERHEAD_BASE64
  };

  const blob = new Blob(
    [JSON.stringify(backupData, null, 2)],
    {type:'application/json'}
  );

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'entry_backup.json';
  a.click();
};

/* ================= RESTORE ================= */
restoreBtn.onclick = ()=>{
  restoreFile.click();
};

restoreFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);

      if(data.template) templateArea.value = data.template;
      if(data.fields) detectedFields = data.fields;
      if(data.entries) entries = data.entries;
      if(data.letterhead) LETTERHEAD_BASE64 = data.letterhead;

      localStorage.setItem('SAVED_TEMPLATE', templateArea.value);
      localStorage.setItem('SAVED_FIELDS', JSON.stringify(detectedFields));
      localStorage.setItem('entries_v1', JSON.stringify(entries));
      if(LETTERHEAD_BASE64)
        localStorage.setItem('LETTERHEAD_BASE64', LETTERHEAD_BASE64);

      renderFields();
      renderSaved();
      updatePreview();

      alert('Backup successfully restored тЬЕ');
    }catch(err){
      alert('Invalid backup file тЭМ');
    }
  };
  r.readAsText(file);
};
</script>
</body>
</html>
